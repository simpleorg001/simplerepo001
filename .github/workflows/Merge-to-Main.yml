name: Check Source Branch
on:
  workflow_dispatch:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize

jobs:
  Merge_Validation:
    name: ðŸ”” Confirm SOURCE branch is allowed
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ”Ž Looking for allowed branches
        shell: pwsh
        run: |
          if ( "${{ github.base_ref }}" -eq "main") {
            if ( ${{ github.head_ref }} -match "^rc/.*" -or ${{ github.head_ref }} -match "^hfc/.*") {
              gh pr merge ${{ github.event.pull_request.number }} --auto
              Write-Host "ðŸš€ðŸ“£ Ready to merge"
            }
            ##### psudo code for allowing devops/* branches to merge directly into main, but only if the author of the PR is on the DevOps team
            elseif ( ${{ github.head_ref }} -match "^devops/.*") {
              $prAuthor = (gh pr view ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --json author | ConvertFrom-Json).author.login
              if ((gh api -X GET /orgs/cmnhospitals/teams/devops/memberships/$prAuthor | ConvertFrom-Json).state -eq "active") {
                Write-Host "ðŸ¤–ðŸš€ðŸ“£ Please continue Lord Commander!"
              }
              else {
                $body="ðŸ“¢ At this moment you're not allowed to merge to main. This incident will be reported to Newman.
                Write-Host $body
                gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body $body
                Write-Host "::error::" + Your are not allowed to merge directly into ${{ github.base_ref }}"
                exit 1  
              }
            }
            else {
              $body="ðŸ“¢ Friendly reminder: Merge requests to main branch are only allowed from rc/** or hfc/** branches."
              Write-Host $body
              gh pr comment ${{ github.event.pull_request.number }} --repo ${{ github.repository }} --body $body
              Write-Host "::error::" + ${{ github.head_ref }} + " is not allowed to merge directly into ${{ github.base_ref }}"
              exit 1
            }
          }
